MikroTik


Команды терминала

<команда> Tab           --вывести доступные команды
<команда> Tab Tab       --список доступных команд для встроенного скриптового языка
? или F1                --вывод всех возможных команд на данном уровне с описанием
..                      --возврат на уровень выше
/                       --возврат в корень
/<команда>              --выполнить команды из основного уровня

Ctrl+K                  --удалить все знаки, начиная со знака, на котором находится курсор, и до конца строки
Ctrl+U                  --удалить все знаки от начала строки и до знака, на котором находится курсор, не считая самого этого знака
Ctrl+H или Backspace    --удалить знак перед курсором и сдвинуть курсор на один знак

Ctrl+C                  --прервать выполнение команды
Ctrl+D                  --завершить сессию и выйти из консоли (поле ввода должно быть пустым)
Ctrl+L или F5           --очистить экран
Ctrl+R или F3           --поиск по истории введенных команд
Ctrl+X или F4           --активация/деактивация безопасного режима
Ctrl+P или ↑            --перемещение назад по истории команд
Ctrl+N или ↓            --перемещение вперед по истории команд

F6                      --переключение между окнами в WinBox
Ctrl+V или F7           --активация/деактивация режима Hot Lock

print [параметры]       --вывести информацию на текущем уровне
      from              --показать только оговоренные элементы в том порядке, в котором они даны
      where             --показать только те элементы, которые соответствуют определенным критериям. Синтаксис тот же, что и у find
      brief             --вывод результатов в краткой форме в виде таблицы
      detail            --вывод подробных результатов
      count-only        --показывает только количество элементов
      file              --записывает результат запроса в файл на роутере
      interval          --обновляет результаты вывода команды print через заданный в секундах интервал
      oid               --выводит OID значение для свойств, которые доступны из SNMP
      without-paging    --печатает вывод без остановки после каждого заполнения экрана.


add <правило> [опции]                           --добавить правило
              copy-from=<номер_правила>         --создать копию нужного элемента. При необходимости свойства элемента можно отредактировать, 
                                                  прямо указав необходимые новые значения
              place-before=<номер_правила>      --указывается номер правила перед которым должно быть помещено вновь создаваемое правило
              disabled=<yes или no>             --отключение элемента (обратная команда enabled)
              comment="комментарий на англ"     --комментарий

find=<номер или название>                       --поиск нужного элемента по указанному свойству или признаку. В связке с командой set, 
                                                  чтобы отредактировать элемент, который нужно найти в массе подобных
                                                  
remove=<номер>,...      --удалить правило(а)

move numbers=<номер>,... destination=[<номер>]         --переместить правило(а), если нужно на последнее место то не указывать destination

set numbers=<номер> <параметр=значение>                --изменить значение параметра
unset numbers=<номер> <параметр>                       --удалить значение параметра

quit  -- завершение сессии


Таблицы:

Filter   --занимается фильтрацией трафика — определяет, пропустить пакет в сеть или отбросить его
NAT      --(Network Address Translation) Изменяет проходящие пакеты. Изменение адреса источника или порт назначения
Mangle   --классифицирует и маркирует трафик и может менять некоторые поля в заголовке (TTL, ToS, DF)
Raw      --обрабатывает пакеты до их попадания в Connection Tracking

Таблицы состоят из цепочек:

input       --трафик к самому роутеру. Обязательное условие попадания в input — адресом назначения пакета должен быть один из адресов роутера, 
              широковещательный адрес сети или широковещательный адрес работающей на роутере службы. Сюда попадает WinBox, SSH, WebFig, ping, 
              VPN и другой трафик, предназначенный роутеру
              
output      --трафик от роутера. Ответы на прилетевшее в input или новые пакеты от роутера (пинг, VPN, SSH-сессия с самого роутера). 
              Эта цепочка редко используется, так как часто роутер считается доверенным звеном и пакеты, генерируемые им, по умолчанию легитимны. 
              
forward     --трафик, проходящий через роутер (когда пакет прилетел в один интерфейс и вылетел с другого или того же самого). 
              Трафик из локалки в интернет, из интернета в локалку, из одного VLAN локалки в другой
              
user chains --пользовательские цепочки. Админ может создавать цепочки правил по своему усмотрению. Это бывает полезно для декомпозиции 
              больших конфигураций. К примеру, можно весь трафик на порты 80 и 443 завернуть в отдельную цепочку WEB и в ней уже делать 
              десятки правил для фильтрации — это визуально упростит настройку, хотя качественно на прохождение трафика не повлияет.


Incoming -->   Routing    ---->    FORWARD     ---->   Outgoing
              decisions                                  /|\
                  |                                       |
                  |                                       |
                 \|/                                      |
                INPUT     ---->     Local      ---->    OUTPUT
                                  processing
                
                
                
                
Connection Tracking    --механизм определения состояния соединений


четыре состояния пакетов:

new           --новый пакет, не принадлежащий ни одному из известных потоков. Это может быть первый пакет для коннекта к серверу RDP, 
                или первый пакет в потоке WinBox, или запрос к DNS. Система запоминает Source IP, Source Port, Destination IP, 
                Destination Port и некоторые другие параметры и записывает эти данные в таблицу. Следующий пакет с такими же данными будет 
                относиться к записанному потоку
        
established   --пакет, принадлежащий существующему потоку. То есть пакет, у которого Source IP, Source Port, Destination IP, 
                Destination Port подходят под одну из записей таблицы ConnTrack (или обратный пакет)
                
related       --пакет, порожденный другим потоком. Некоторые протоколы, такие как FTP, SIP, PPTP, используют для работы несколько потоков. 
                Например, управляющие команды FTP ходят по порту TCP 21, но данные передаются с порта TCP 20. При попытке получения 
                или отправки данных на FTP в потоке на порт 21 сервер сообщает: «А сейчас я открою 20-й порт, и ты забирай данные с него», 
                после этого клиент посылает пакет на 20-й порт сервера. Этот пакет будет считаться related, так как он порожден потоком 21-го порта
                
invalid       --все, что не относится к перечисленным выше состояниям. Пример: сессия корректно закрылась, но из-за ошибок маршрутизации 
                часть пакетов из середины сессии улетела другим путем. Когда они пришли, их сессия уже закрыта и роутер о них ничего не знает. 
                Они не new и не относятся к существующим соединениям, поэтому считаем их invalid.


WAN           --(Wide Area Network) глобальная вычислительная сеть
LAN           --(Local Area Networks) локальная вычислительная сеть



Rout list     --список маршрутов

Алгоритмы выбора маршрута:

Самый высокий приоритет имеет сеть/адрес /32 маской. Чем уже маска, тем приоритетнее
Default Route имеет самый наименьший приоритет 0.0.0.0/0.

После выбора маршрута происходит выбор по метрике, чем меньше метрика, тем приоритетнее:

distance=0    --наивысшая метрика
distance=254  --наименьшая метрика
distance=255  --недоступный маршрут

метки состояния:
D (Dinamic)    --
A (Active)     --
C (Connected)  --



